name: Build and Push Docker # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠ workflow ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô GitHub Actions

on: # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á workflow
  push: # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ push ‡πÇ‡∏Ñ‡πâ‡∏î
    branches: [main] # ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ branch main

jobs: # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô (jobs)
  build: # ‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô (job) ‡∏ß‡πà‡∏≤ build
    runs-on: ubuntu-latest # ‡πÉ‡∏ä‡πâ runner ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Ubuntu ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

    steps: # ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô job ‡∏ô‡∏µ‡πâ
      - uses: actions/checkout@v3 # ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ã‡∏≠‡∏£‡πå‡∏™‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å repository

      - name: Set up Python # ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤ Set up Python
        uses: actions/setup-python@v4 # ‡πÉ‡∏ä‡πâ action ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Python
        with:
          python-version: '3.11' # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Python ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

      - name: Install dependencies # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests # ‡∏£‡∏±‡∏ô unit tests ‡∏î‡πâ‡∏ß‡∏¢ pytest
        run: |
          PYTHONPATH=. pytest tests

      - name: Log in to DockerHub # ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ DockerHub ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ username ‡πÅ‡∏•‡∏∞ password ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô secrets
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image # ‡∏™‡∏£‡πâ‡∏≤‡∏á Docker image ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏õ‡πá‡∏ô latest ‡πÅ‡∏•‡∏∞ commit hash ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        run: |
          docker build -t orathaisu/hello-python:latest . # ‡∏™‡∏£‡πâ‡∏≤‡∏á image ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏õ‡πá‡∏ô latest
          docker tag orathaisu/hello-python:latest orathaisu/hello-python:${{ github.sha }} # ‡πÅ‡∏ó‡πá‡∏Å image ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ commit hash

      - name: Push Docker images # ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Docker image ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á DockerHub ‡∏ó‡∏±‡πâ‡∏á 2 tag
        run: |
          docker push orathaisu/hello-python:latest # push image ‡∏ó‡∏µ‡πà tag ‡πÄ‡∏õ‡πá‡∏ô latest
          docker push orathaisu/hello-python:${{ github.sha }} # push image ‡∏ó‡∏µ‡πà tag ‡πÄ‡∏õ‡πá‡∏ô commit hash

      - name: Replace image tag in deployment.yaml # ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà REPLACE_TAG ‡πÉ‡∏ô deployment.yaml ‡∏î‡πâ‡∏ß‡∏¢ commit hash ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        run: sed -i "s|REPLACE_TAG|${{ github.sha }}|g" k8s/deployment.yaml

      - name: Commit updated deployment.yaml # commit ‡πÅ‡∏•‡∏∞ push ‡πÑ‡∏ü‡∏•‡πå deployment.yaml ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà repository ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ deployment ‡πÉ‡∏ä‡πâ image tag ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com" # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ email ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö git
          git config --global user.name "github-actions[bot]" # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö git
          git add k8s/deployment.yaml # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå deployment.yaml ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ç‡πâ‡∏≤ staging
          git commit -m "üöÄ Deploy image ${{ github.sha }}" || true # commit ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà error)
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main # push ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà branch main
